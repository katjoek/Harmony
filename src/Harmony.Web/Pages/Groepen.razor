@page "/groepen"
@using Harmony.ApplicationCore.DTOs
@using Harmony.ApplicationCore.Queries.Groups
@using Harmony.ApplicationCore.Queries.Persons
@using Harmony.ApplicationCore.Commands.Groups
@using Harmony.Web.Models
@using LiteBus.Commands.Abstractions
@using LiteBus.Queries.Abstractions
@implements IDisposable

<PageTitle>Groepen - Harmony</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Groepen</h1>
    <div class="d-flex gap-2">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input @ref="groupSearchInput" id="group-search-input" class="form-control" placeholder="Zoeken... (F3)" @bind="groupSearch" @bind:event="oninput" />
            @if (!string.IsNullOrWhiteSpace(groupSearch))
            {
                <button type="button" class="btn btn-outline-secondary" title="Wissen" @onclick="ClearGroupSearch">
                    <i class="fas fa-times"></i>
                </button>
            }
        </div>
        <button type="button" class="btn btn-primary" @onclick="OpenCreateModal">
            <i class="fas fa-plus me-2"></i>
            Nieuwe Groep
        </button>
    </div>
</div>

@if (groups != null)
{
    <div class="mb-2">
        @if (string.IsNullOrWhiteSpace(groupSearch))
        {
            <span class="text-muted">@groups.Count @(groups.Count == 1 ? "groep" : "groepen")</span>
        }
        else
        {
            <span class="text-muted">@FilteredGroups.Count() @(FilteredGroups.Count() == 1 ? "groep" : "groepen") gevonden</span>
        }
    </div>
}

<!-- Always show the table structure immediately for fast rendering -->
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Naam</th>
                <th>Coördinator</th>
                <th>&#35; Leden</th>
                <th>Acties</th>
            </tr>
        </thead>
        <tbody>
            @if (groups == null)
            {
                <!-- Skeleton loading rows for instant feedback -->
                @for (int i = 0; i < 5; i++)
                {
                    <tr>
                        <td><div class="placeholder-glow"><span class="placeholder col-8"></span></div></td>
                        <td><div class="placeholder-glow"><span class="placeholder col-6"></span></div></td>
                        <td><div class="placeholder-glow"><span class="placeholder col-2"></span></div></td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-secondary" disabled>
                                    <i class="fas fa-users"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary" disabled>
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary" disabled>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            }
            else if (groups.Count == 0)
            {
                <tr>
                    <td colspan="4" class="text-center text-muted">Geen groepen gevonden.</td>
                </tr>
            }
            else if (!FilteredGroups.Any())
            {
                <tr>
                    <td colspan="4" class="text-center text-muted">Geen resultaten voor "@groupSearch".</td>
                </tr>
            }
            else
            {
                @foreach (var group in FilteredGroups)
                {
                    <tr title="@GetGroupMembersTooltip(group)">
                        <td>@group.Name</td>
                        <td>@group.CoordinatorName</td>
                        <td>@group.MemberCount</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-info" @onclick="@(() => OpenMembersModal(group))">
                                    <i class="fas fa-users"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-primary" @onclick="@(() => OpenEditModal(group))">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" @onclick="@(() => DeleteGroup(group))">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<!-- Create/Edit Modal -->
<div class="modal fade @(showGroupModal ? "show d-block" : "")" tabindex="-1" style="background-color: rgba(0,0,0,0.5)">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@modalTitle</h5>
                <button type="button" class="btn-close" @onclick="CloseModal"></button>
            </div>
            <EditForm Model="@groupModel" OnValidSubmit="@SaveGroup">
                <DataAnnotationsValidator />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Groepsnaam *</label>
                        <InputText @bind-Value="@groupModel.Name" class="form-control" />
                        <ValidationMessage For="@(() => groupModel.Name)" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Coördinator</label>
                        <InputSelect @bind-Value="@groupModel.CoordinatorId" class="form-select">
                            <option value="">Geen coördinator</option>
                            @if (coordinatorCandidates != null)
                            {
                                @foreach (var person in coordinatorCandidates)
                                {
                                    <option value="@person.Id">@person.FullName</option>
                                }
                            }
                        </InputSelect>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Annuleren</button>
                    <button type="submit" class="btn btn-primary">Opslaan</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

<!-- Members Modal Component -->
@if (selectedGroup != null && groupMembers != null && availablePersons != null)
{
    <DualListMembershipModal
        Show="@showMembersModal"
        Title="@($"Leden van {selectedGroup.Name} beheren")"
        LeftLabel="Beschikbare personen"
        RightLabel="Leden"
        LeftSelectId="group-available"
        RightSelectId="group-members"
        LeftItems="@availablePersons.Select(p => new Harmony.Web.Models.DualListItem(p.Id, p.FullName)).ToList()"
        RightItems="@groupMembers.Select(p => new Harmony.Web.Models.DualListItem(p.Id, p.FullName)).ToList()"
        IsBusy="@isProcessing"
        Close="@CloseMembersModal"
        MoveLeftToRight="@MoveAvailableToMembers"
        MoveRightToLeft="@MoveMembersToAvailable" />
}

@code {
    private List<GroupDto>? groups;
    private List<PersonDto>? allPersons;
    private List<PersonDto>? groupMembers;
    private List<PersonDto>? availablePersons;
    private List<PersonDto>? coordinatorCandidates;
    private GroupViewModel groupModel = new();
    private GroupDto? selectedGroup;
    private string modalTitle = "";
    private bool isEditing = false;
    private bool showGroupModal = false;
    private bool showMembersModal = false;
    private string groupSearch = "";
    private bool isProcessing = false;
    private ElementReference groupSearchInput;

    protected override Task OnInitializedAsync()
    {
        // Start loading data in the background without blocking the initial render
        _ = Task.Run(async () =>
        {
            try
            {
                await LoadData();
            }
            catch (Exception ex)
            {
                // Log error but don't crash the page
                Console.WriteLine($"Error loading data: {ex.Message}");
            }
        });
        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Register F3 keyboard shortcut to focus search
            await JSRuntime.InvokeVoidAsync("searchUtils.registerF3Focus", "group-search-input");
            
            // Small delay to ensure the element is fully rendered
            await Task.Delay(50);
            try
            {
                await groupSearchInput.FocusAsync();
            }
            catch
            {
                // Ignore focus errors (e.g., if element not yet rendered)
            }
        }
    }

    public void Dispose()
    {
        // Unregister F3 handler when component is disposed
        _ = Task.Run(async () =>
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("searchUtils.unregisterF3Focus");
            }
            catch
            {
                // Ignore errors during disposal
            }
        });
    }

    private async Task LoadData()
    {
        // Load both in parallel for maximum performance
        var groupsTask = LoadGroups();
        var personsTask = LoadPersons();
        
        await Task.WhenAll(groupsTask, personsTask);
    }

    private async Task LoadGroups()
    {
        var query = new GetAllGroupsQuery();
        groups = (await QueryMediator.QueryAsync(query)).ToList();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadPersons()
    {
        var query = new GetAllPersonsQuery();
        allPersons = (await QueryMediator.QueryAsync(query)).ToList();
        UpdateCoordinatorCandidatesForCurrentModel();
        await InvokeAsync(StateHasChanged); // Update UI so tooltips work
    }

    private void OpenCreateModal()
    {
        groupModel = new GroupViewModel();
        modalTitle = "Nieuwe Groep";
        isEditing = false;
        showGroupModal = true;
        UpdateCoordinatorCandidatesForCurrentModel();
    }

    private void OpenEditModal(GroupDto group)
    {
        groupModel = new GroupViewModel
        {
            Id = group.Id,
            Name = group.Name,
            CoordinatorId = group.CoordinatorId
        };
        modalTitle = "Groep Bewerken";
        isEditing = true;
        showGroupModal = true;
        UpdateCoordinatorCandidatesForCurrentModel();
    }

    private async Task OpenMembersModal(GroupDto group)
    {
        selectedGroup = group;
        // Ensure we have the latest data before opening the modal
        await LoadPersons();
        await LoadGroupMembers(group.Id);
        UpdateAvailablePersons();
        showMembersModal = true;
    }

    private Task LoadGroupMembers(string groupId)
    {
        if (allPersons == null) return Task.CompletedTask;
        
        groupMembers = allPersons
            .Where(p => p.GroupIds.Contains(groupId))
            .OrderBy(p => p.FirstName, StringComparer.OrdinalIgnoreCase)
            .ThenBy(p => p.Surname ?? "", StringComparer.OrdinalIgnoreCase)
            .ToList();
        return Task.CompletedTask;
    }

    private void UpdateAvailablePersons()
    {
        if (allPersons == null || groupMembers == null) return;

        var memberIds = groupMembers.Select(m => m.Id).ToHashSet();
        availablePersons = allPersons
            .Where(p => !memberIds.Contains(p.Id))
            .OrderBy(p => p.FirstName, StringComparer.OrdinalIgnoreCase)
            .ThenBy(p => p.Surname ?? "", StringComparer.OrdinalIgnoreCase)
            .ToList();
    }

    private async Task SaveGroup()
    {
        try
        {
            if (isEditing)
            {
                var command = new UpdateGroupCommand(
                    groupModel.Id!,
                    groupModel.Name!,
                    string.IsNullOrEmpty(groupModel.CoordinatorId) ? null : groupModel.CoordinatorId);

                await CommandMediator.SendAsync(command);
            }
            else
            {
                var command = new CreateGroupCommand(
                    groupModel.Name!,
                    string.IsNullOrEmpty(groupModel.CoordinatorId) ? null : groupModel.CoordinatorId);

                await CommandMediator.SendAsync(command);
            }

            await LoadGroups();
            CloseModal();
            ShowSuccessMessage("Groep succesvol opgeslagen!");
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Fout bij opslaan: {ex.Message}");
        }
    }

    private async Task DeleteGroup(GroupDto group)
    {
        if (await ShowConfirmDialog($"Weet u zeker dat u groep '{group.Name}' wilt verwijderen?"))
        {
            try
            {
                var command = new DeleteGroupCommand(group.Id);
                await CommandMediator.SendAsync(command);
                await LoadGroups();
                ShowSuccessMessage("Groep succesvol verwijderd!");
            }
            catch (Exception ex)
            {
                ShowErrorMessage($"Fout bij verwijderen: {ex.Message}");
            }
        }
    }

    private async Task MoveAvailableToMembers(IEnumerable<string> personIds)
    {
        if (selectedGroup == null) return;
        var ids = personIds?.ToArray() ?? Array.Empty<string>();
        if (ids.Length == 0) return;

        try
        {
            isProcessing = true;
            foreach (var pid in ids)
            {
                var command = new Harmony.ApplicationCore.Commands.Membership.AddPersonToGroupCommand(pid, selectedGroup.Id);
                await CommandMediator.SendAsync(command);
            }

            await RefreshMembershipState();
            ShowSuccessMessage("Toegevoegd aan groep.");
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Fout bij toevoegen: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task MoveMembersToAvailable(IEnumerable<string> personIds)
    {
        if (selectedGroup == null) return;
        var ids = personIds?.ToArray() ?? Array.Empty<string>();
        if (ids.Length == 0) return;

        try
        {
            isProcessing = true;
            foreach (var pid in ids)
            {
                var command = new Harmony.ApplicationCore.Commands.Membership.RemovePersonFromGroupCommand(pid, selectedGroup.Id);
                await CommandMediator.SendAsync(command);
            }

            await RefreshMembershipState();
            ShowSuccessMessage("Verwijderd uit groep.");
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Fout bij verwijderen: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RefreshMembershipState()
    {
        if (selectedGroup == null) return;
        await LoadPersons();
        await LoadGroups();
        await LoadGroupMembers(selectedGroup.Id);
        UpdateAvailablePersons();
        StateHasChanged();
    }

    private void CloseModal()
    {
        showGroupModal = false;
    }

    private void CloseMembersModal()
    {
        showMembersModal = false;
        selectedGroup = null;
        groupMembers = null;
        availablePersons = null;
    }

    private string GetGroupMembersTooltip(GroupDto group)
    {
        // Return empty string if data not yet loaded - no tooltip will be shown
        if (allPersons == null)
            return string.Empty;

        if (!group.MemberIds.Any())
            return "Geen leden";

        var memberNames = allPersons
            .Where(p => group.MemberIds.Contains(p.Id))
            .Select(p => p.FullName)
            .OrderBy(n => n, StringComparer.OrdinalIgnoreCase)
            .ToList();

        return memberNames.Any() 
            ? $"Leden: {string.Join(", ", memberNames)}"
            : "Geen leden";
    }

    private void UpdateCoordinatorCandidatesForCurrentModel()
    {
        if (allPersons == null)
        {
            coordinatorCandidates = null;
            return;
        }

        if (isEditing && !string.IsNullOrEmpty(groupModel.Id))
        {
            coordinatorCandidates = allPersons
                .Where(p => p.GroupIds.Contains(groupModel.Id!))
                .OrderBy(p => p.FirstName, StringComparer.OrdinalIgnoreCase)
                .ThenBy(p => p.Surname ?? "", StringComparer.OrdinalIgnoreCase)
                .ToList();
        }
        else
        {
            coordinatorCandidates = new List<PersonDto>();
        }

        if (!string.IsNullOrEmpty(groupModel.CoordinatorId))
        {
            var existsInCandidates = coordinatorCandidates.Any(p => p.Id == groupModel.CoordinatorId);
            if (!existsInCandidates)
            {
                groupModel.CoordinatorId = null;
            }
        }
    }

    private async Task<bool> ShowConfirmDialog(string message)
    {
        return await JSRuntime.InvokeAsync<bool>("confirm", message);
    }

    private void ShowSuccessMessage(string message)
    {
        Console.WriteLine($"SUCCESS: {message}");
    }

    private void ShowErrorMessage(string message)
    {
        Console.WriteLine($"ERROR: {message}");
    }

    private IEnumerable<GroupDto> FilteredGroups
    {
        get
        {
            var filtered = string.IsNullOrWhiteSpace(groupSearch) || groups == null
                ? groups ?? Enumerable.Empty<GroupDto>()
                : groups.Where(g => MatchesGroup(g, groupSearch));
            
            // Apply case-insensitive sorting
            return filtered.OrderBy(g => g.Name, StringComparer.OrdinalIgnoreCase);
        }
    }

    private static bool MatchesGroup(GroupDto g, string term)
    {
        var t = term.Trim();
        return ContainsInsensitive(g.Name, t)
            || ContainsInsensitive(g.CoordinatorName, t)
            || g.MemberCount.ToString().Contains(t, StringComparison.OrdinalIgnoreCase);
    }

    private static bool ContainsInsensitive(string? haystack, string needle)
        => !string.IsNullOrWhiteSpace(haystack) && haystack.Contains(needle, StringComparison.OrdinalIgnoreCase);

    private void ClearGroupSearch()
    {
        groupSearch = "";
    }
}

@inject ICommandMediator CommandMediator
@inject IQueryMediator QueryMediator
@inject IJSRuntime JSRuntime
