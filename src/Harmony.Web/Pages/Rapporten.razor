@page "/rapporten"
@using Harmony.ApplicationCore.DTOs
@using Harmony.ApplicationCore.Queries.Groups
@using Harmony.ApplicationCore.Queries.Persons
@using Harmony.Web.Models
@using LiteBus.Queries.Abstractions
@using LiteBus.Commands.Abstractions
@using System.Linq

<PageTitle>Rapporten - Harmony</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Rapporten</h1>
</div>

<!-- Report Generation Form -->
<div class="row">
    <div class="col-lg-8 col-xl-7">
        <div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Rapport Genereren</h5>
    </div>
    <div class="card-body">
        <EditForm Model="@reportModel" OnValidSubmit="@GenerateReport">
            <DataAnnotationsValidator />
            
            <!-- Report Type Selection -->
            <div class="mb-3">
                <label class="form-label">Rapporttype *</label>
                <div class="d-flex gap-4">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="reportType" @onchange="@(async () => await OnReportTypeChanged("Group"))" checked="@(reportModel.ReportType == "Group")" id="typeGroup">
                        <label class="form-check-label" for="typeGroup">
                            Groepsrapport
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="reportType" @onchange="@(async () => await OnReportTypeChanged("Birthday"))" checked="@(reportModel.ReportType == "Birthday")" id="typeBirthday">
                        <label class="form-check-label" for="typeBirthday">
                            Verjaardagen
                        </label>
                    </div>
                </div>
            </div>

            @if (reportModel.ReportType == "Group")
            {
                <!-- Group Selection -->
                <div class="mb-3">
                    <label class="form-label">Groep selecteren *</label>
                    <InputSelect TValue="string"
                                 Value="@reportModel.SelectedGroupId"
                                 ValueChanged="@OnSelectedGroupChanged"
                                 ValueExpression="@(() => reportModel.SelectedGroupId)"
                                 class="form-select">
                        <option value="">-- Selecteer een groep --</option>
                        @if (groups != null)
                        {
                            @foreach (var group in groups)
                            {
                                <option value="@group.Id">@group.Name (@group.MemberCount leden)</option>
                            }
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => reportModel.SelectedGroupId)" />
                </div>
            }
            else if (reportModel.ReportType == "Birthday")
            {
                <!-- Group Selection (Optional) -->
                <div class="mb-3">
                    <label class="form-label">Groep selecteren (optioneel)</label>
                    <InputSelect TValue="string"
                                 Value="@reportModel.SelectedGroupId"
                                 ValueChanged="@OnBirthdayGroupChanged"
                                 ValueExpression="@(() => reportModel.SelectedGroupId)"
                                 class="form-select">
                        <option value="">-- Alle personen --</option>
                        @if (groups != null)
                        {
                            @foreach (var group in groups)
                            {
                                <option value="@group.Id">@group.Name (@group.MemberCount leden)</option>
                            }
                        }
                    </InputSelect>
                    <small class="form-text text-muted">
                        Selecteer een groep om alleen personen uit die groep te tonen, of laat leeg voor alle personen.
                    </small>
                </div>
                
                <!-- Month Selection -->
                <div class="mb-3">
                    <label class="form-label">Maand *</label>
                    <InputSelect TValue="int" @bind-Value="reportModel.SelectedMonth" class="form-select">
                        @for (int m = 1; m <= 12; m++)
                        {
                            <option value="@m">@GetDutchMonthName(m)</option>
                        }
                    </InputSelect>
                </div>
            }

            <ReportOptions Model="@reportModel" OnFieldChangedCallback="@(() => InvokeAsync(StateHasChanged))" />

            <!-- Generate Button -->
            <div class="d-flex align-items-center gap-3">
                <div class="flex-grow-1">
                    @if (reportModel.ReportType == "Group" && !string.IsNullOrEmpty(reportModel.SelectedGroupId) && selectedGroup != null)
                    {
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Dit rapport bevat @memberCount leden van groep "@selectedGroup.Name"
                        </small>
                    }
                    else if (reportModel.ReportType == "Birthday" && allPersons != null)
                    {
                        var birthdayPersons = GetFilteredBirthdayPersons();
                        var count = birthdayPersons.Count();
                        var groupInfo = !string.IsNullOrEmpty(reportModel.SelectedGroupId) && selectedBirthdayGroup != null
                            ? $" uit groep \"{selectedBirthdayGroup.Name}\""
                            : "";
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            @count personen met verjaardag in @GetDutchMonthName(reportModel.SelectedMonth)@groupInfo
                        </small>
                    }
                </div>
                <button type="submit" class="btn btn-primary" disabled="@(isGenerating || (reportModel.ReportType == "Group" && string.IsNullOrEmpty(reportModel.SelectedGroupId)))">
                    @if (isGenerating)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <text>Genereren...</text>
                    }
                    else
                    {
                        <i class="fas fa-download me-2"></i>
                        <text>Rapport Genereren</text>
                    }
                </button>
            </div>
        </EditForm>
    </div>
        </div>
    </div>
</div>

<!-- Report Preview -->
<div class="card">
    <div class="card-header">
        <h6 class="mb-0">Voorbeeld</h6>
    </div>
    <div class="card-body">
        @if (reportModel.ReportType == "Group" && selectedGroup != null)
        {
            <h6>@selectedGroup.Name</h6>
            <p class="small text-muted mb-2">
                Gegenereerd op: @DateTime.Now.ToString("dd-MM-yyyy HH:mm")
            </p>
            @if (!string.IsNullOrEmpty(selectedGroup.CoordinatorName))
            {
                <p class="small mb-2">
                    <strong>Co√∂rdinator:</strong> @selectedGroup.CoordinatorName
                </p>
            }
            
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Volledige naam</th>
                            @if (reportModel.IncludeDateOfBirth)
                            {
                                <th>Geboortedatum</th>
                            }
                            @if (reportModel.IncludeAddress)
                            {
                                <th>Adres</th>
                            }
                            @if (reportModel.IncludePhoneNumber)
                            {
                                <th>Telefoon</th>
                            }
                            @if (reportModel.IncludeEmailAddress)
                            {
                                <th>E-mail</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @if (groupMembers != null)
                        {
                            @foreach (var member in GetSortedGroupMembers().Take(3))
                            {
                                <tr>
                                    <td>@member.FullName</td>
                                    @if (reportModel.IncludeDateOfBirth)
                                    {
                                        <td>@member.DateOfBirth?.ToString("dd-MM-yyyy")</td>
                                    }
                                    @if (reportModel.IncludeAddress)
                                    {
                                        <td>@member.FormattedAddress</td>
                                    }
                                    @if (reportModel.IncludePhoneNumber)
                                    {
                                        <td>@member.PhoneNumber</td>
                                    }
                                    @if (reportModel.IncludeEmailAddress)
                                    {
                                        <td>@member.EmailAddress</td>
                                    }
                                </tr>
                            }
                            @if (GetSortedGroupMembers().Count() > 3)
                            {
                                <tr>
                                    <td colspan="@GetColumnCount()" class="text-center text-muted">
                                        ... en @(GetSortedGroupMembers().Count() - 3) meer
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <h6>Voorbeeld</h6>
            <p class="small text-muted mb-2">
                Gegenereerd op: @DateTime.Now.ToString("dd-MM-yyyy HH:mm")
            </p>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Volledige naam</th>
                            @if (reportModel.IncludeDateOfBirth)
                            {
                                <th>Geboortedatum</th>
                            }
                            @if (reportModel.IncludeAddress)
                            {
                                <th>Adres</th>
                            }
                            @if (reportModel.IncludePhoneNumber)
                            {
                                <th>Telefoon</th>
                            }
                            @if (reportModel.IncludeEmailAddress)
                            {
                                <th>E-mail</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @if (reportModel.ReportType == "Birthday" && allPersons != null)
                        {
                            var sample = GetSortedBirthdayPersons().Take(3);
                            foreach (var member in sample)
                            {
                                <tr>
                                    <td>@member.FullName</td>
                                    @if (reportModel.IncludeDateOfBirth)
                                    {
                                        <td>@member.DateOfBirth?.ToString("dd-MM-yyyy")</td>
                                    }
                                    @if (reportModel.IncludeAddress)
                                    {
                                        <td>@member.FormattedAddress</td>
                                    }
                                    @if (reportModel.IncludePhoneNumber)
                                    {
                                        <td>@member.PhoneNumber</td>
                                    }
                                    @if (reportModel.IncludeEmailAddress)
                                    {
                                        <td>@member.EmailAddress</td>
                                    }
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="@GetColumnCount()" class="text-muted">Selecteer een groep of maand</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@code {
    private List<GroupDto>? groups;
    private List<PersonDto>? allPersons;
    private List<PersonDto>? groupMembers;
    private GroupDto? selectedGroup;
    private GroupDto? selectedBirthdayGroup;
    private ReportModel reportModel = new();
    private bool isGenerating = false;
    private int memberCount = 0;

    protected override Task OnInitializedAsync()
    {
        // Start loading data in the background without blocking the initial render
        _ = Task.Run(async () =>
        {
            try
            {
                await LoadData();
                await LoadBirthdayGroupFromConfig();
            }
            catch (Exception ex)
            {
                // Log error but don't crash the page
                Console.WriteLine($"Error loading data: {ex.Message}");
            }
        });
        return Task.CompletedTask;
    }

    private async Task LoadData()
    {
        var groupsTask = LoadGroups();
        var personsTask = LoadPersons();
        await Task.WhenAll(groupsTask, personsTask);
    }

    private async Task LoadGroups()
    {
        var query = new GetAllGroupsQuery();
        groups = (await QueryMediator.QueryAsync(query)).ToList();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadPersons()
    {
        var query = new GetAllPersonsQuery();
        allPersons = (await QueryMediator.QueryAsync(query)).ToList();
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnReportTypeChanged(string reportType)
    {
        reportModel.ReportType = reportType;
        
        if (reportType == "Birthday")
        {
            // Load saved Birthday group when switching to Birthday report type
            await LoadBirthdayGroupFromConfig();
        }
        else if (reportType == "Group")
        {
            // Clear SelectedGroupId when switching to Group report type
            // User must select a group for Group reports
            reportModel.SelectedGroupId = null;
            selectedGroup = null;
            groupMembers = null;
            memberCount = 0;
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnSelectedGroupChanged(string? value)
    {
        reportModel.SelectedGroupId = value;
        await OnGroupSelectionChanged(value);
    }

    private async Task OnBirthdayGroupChanged(string? value)
    {
        reportModel.SelectedGroupId = value;
        await OnBirthdayGroupSelectionChanged(value);
        await SaveBirthdayGroupToConfig(value);
    }

    private async Task OnBirthdayGroupSelectionChanged(string? groupId)
    {
        if (!string.IsNullOrEmpty(groupId) && groups != null)
        {
            selectedBirthdayGroup = groups.FirstOrDefault(g => g.Id == groupId);
        }
        else
        {
            selectedBirthdayGroup = null;
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadBirthdayGroupFromConfig()
    {
        try
        {
            var query = new Harmony.ApplicationCore.Queries.Config.GetConfigValueQuery("BirthdayReport.SelectedGroupId");
            var savedGroupId = await QueryMediator.QueryAsync(query);
            
            if (!string.IsNullOrEmpty(savedGroupId) && groups != null)
            {
                reportModel.SelectedGroupId = savedGroupId;
                await OnBirthdayGroupSelectionChanged(savedGroupId);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading birthday group from config: {ex.Message}");
        }
    }

    private async Task SaveBirthdayGroupToConfig(string? groupId)
    {
        try
        {
            var command = new Harmony.ApplicationCore.Commands.Config.SetConfigValueCommand("BirthdayReport.SelectedGroupId", groupId);
            await CommandMediator.SendAsync(command);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving birthday group to config: {ex.Message}");
        }
    }

    private async Task OnGroupSelectionChanged(string? groupId)
    {
        if (!string.IsNullOrEmpty(groupId) && groups != null && allPersons != null)
        {
            selectedGroup = groups.FirstOrDefault(g => g.Id == groupId);
            groupMembers = allPersons.Where(p => p.GroupIds.Contains(groupId)).ToList();
            memberCount = groupMembers.Count;
        }
        else
        {
            selectedGroup = null;
            groupMembers = null;
            memberCount = 0;
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task GenerateReport()
    {
        if (reportModel.ReportType == "Group" && (selectedGroup == null || groupMembers == null)) return;

        try
        {
            isGenerating = true;
            StateHasChanged();

            var timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
            string fileName;
            if (reportModel.ReportType == "Group")
            {
                var adaptedGroupName = selectedGroup!.Name.Replace(" ", "_");
                fileName = $"{adaptedGroupName}_{timestamp}";
            }
            else
            {
                var monthName = GetDutchMonthName(reportModel.SelectedMonth).Replace(" ", "_");
                fileName = $"Verjaardagen_{monthName}_{timestamp}";
            }
            
            if (reportModel.OutputFormat == "PDF")
            {
                await GeneratePdfReport(fileName);
            }
            else if (reportModel.OutputFormat == "Excel")
            {
                await GenerateExcelReport(fileName);
            }

            ShowSuccessMessage($"Rapport succesvol gegenereerd!");
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Fout bij genereren rapport: {ex.Message}");
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private async Task GeneratePdfReport(string fileName)
    {
        if (reportModel.ReportType == "Group")
        {
            if (selectedGroup == null || groupMembers == null) return;
            var reportData = await ReportService.GeneratePdfReportAsync(selectedGroup, groupMembers, reportModel);
            await DownloadFile($"{fileName}.pdf", reportData, "application/pdf");
        }
        else
        {
            if (allPersons == null) return;
            var monthName = GetDutchMonthName(reportModel.SelectedMonth);
            var persons = GetFilteredBirthdayPersons()
                                    .OrderBy(p => p.DateOfBirth?.Day)
                                    .ToList();
            var reportData = await ReportService.GenerateBirthdayPdfReportAsync(monthName, persons, reportModel);
            await DownloadFile($"{fileName}.pdf", reportData, "application/pdf");
        }
    }

    private async Task GenerateExcelReport(string fileName)
    {
        if (reportModel.ReportType == "Group")
        {
            if (selectedGroup == null || groupMembers == null) return;
            var reportData = await ReportService.GenerateExcelReportAsync(selectedGroup, groupMembers, reportModel);
            await DownloadFile($"{fileName}.xlsx", reportData, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        }
        else
        {
            if (allPersons == null) return;
            var monthName = GetDutchMonthName(reportModel.SelectedMonth);
            var persons = GetFilteredBirthdayPersons()
                                    .OrderBy(p => p.DateOfBirth?.Day)
                                    .ToList();
            var reportData = await ReportService.GenerateBirthdayExcelReportAsync(monthName, persons, reportModel);
            await DownloadFile($"{fileName}.xlsx", reportData, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        }
    }

    private async Task DownloadFile(string fileName, byte[] data, string contentType)
    {
        try
        {
            var base64 = Convert.ToBase64String(data);
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64, contentType);
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Fout bij downloaden: {ex.Message}");
        }
    }

    private int GetColumnCount()
    {
        int count = 1; // Always include full name
        if (reportModel.IncludeDateOfBirth) count++;
        if (reportModel.IncludeAddress) count++;
        if (reportModel.IncludePhoneNumber) count++;
        if (reportModel.IncludeEmailAddress) count++;
        return count;
    }

    private static string GetDutchMonthName(int month)
    {
        var culture = new System.Globalization.CultureInfo("nl-NL");
        return culture.DateTimeFormat.GetMonthName(month);
    }

    private void ShowSuccessMessage(string message)
    {
        Console.WriteLine($"SUCCESS: {message}");
    }

    private void ShowErrorMessage(string message)
    {
        Console.WriteLine($"ERROR: {message}");
    }

    private IEnumerable<PersonDto> GetSortedGroupMembers()
    {
        if (groupMembers == null) return Enumerable.Empty<PersonDto>();
        
        return reportModel.SortOrder == "FirstName"
            ? groupMembers.OrderBy(p => p.FirstName).ThenBy(p => p.Surname ?? "")
            : groupMembers.OrderBy(p => p.Surname ?? "").ThenBy(p => p.FirstName);
    }

    private IEnumerable<PersonDto> GetFilteredBirthdayPersons()
    {
        if (allPersons == null) return Enumerable.Empty<PersonDto>();
        
        var filtered = allPersons.Where(p => p.DateOfBirth?.Month == reportModel.SelectedMonth);
        
        // Filter by group if selected
        if (!string.IsNullOrEmpty(reportModel.SelectedGroupId))
        {
            filtered = filtered.Where(p => p.GroupIds.Contains(reportModel.SelectedGroupId));
        }
        
        return filtered;
    }

    private IEnumerable<PersonDto> GetSortedBirthdayPersons()
    {
        var birthdayPersons = GetFilteredBirthdayPersons()
            .OrderBy(p => p.DateOfBirth?.Day);
        
        return reportModel.SortOrder == "FirstName"
            ? birthdayPersons.ThenBy(p => p.FirstName).ThenBy(p => p.Surname ?? "")
            : birthdayPersons.ThenBy(p => p.Surname ?? "").ThenBy(p => p.FirstName);
    }
}

@inject IQueryMediator QueryMediator
@inject ICommandMediator CommandMediator
@inject IJSRuntime JSRuntime
@inject Harmony.Web.Services.IReportService ReportService
